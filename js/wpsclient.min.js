String.prototype.endsWith=function(a){return this.indexOf(a,this.length-a.length)!==-1};function generateUUID(){var b=new Date().getTime();if(window.performance&&typeof window.performance.now==="function"){b+=performance.now()}var a="xxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var d=(b+Math.random()*16)%16|0;b=Math.floor(b/16);return(e=="x"?d:(d&3|8)).toString(16)});return"uuid"+a}function BlueBridgeWPSClient(a){this.right=undefined;this.init=function(){if(a==undefined){alert("The Bluebridge WPS javascript client can not be loaded without options");return}this.wps_uri=a.wps_uri!=undefined?a.wps_uri:"http://dataminer1-d-d4s.d4science.org/wps/WebProcessingService";this.wps_username=a.wps_username!=undefined?a.wps_username:null;this.wps_token=a.wps_token!=undefined?a.wps_token:null;this.experiment_identifier=a.experiment_identifier!=undefined?a.experiment_identifier:null;this.opencpu_url=a.opencpu_url!=undefined?a.opencpu_url:"//access.d4science.org/ocpu/library/WPSClient/R";this.container=a.container!=undefined?a.container:null;this.style=a.style!=undefined?a.style:"horizontal";this.exclude=a.exclude!=undefined?a.exclude:[];this.include=a.include!=undefined?a.include:[];this.expands=a.expands!=undefined?a.expands:false;var m="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";var j=false;var g="";if(this.wps_username==null){g+="wps_username ";j=true}if(this.wps_token==null){g+="wps_token ";j=true}if(this.experiment_identifier==null){g+="experiment_identifier ";j=true}if(this.container==null){g+="container ";j=true}if(j){g+=" option(s) cannot be unset";alert(g);return}try{ocpu.seturl(this.opencpu_url)}catch(e){alert(e)}finally{if(this.container.charAt(0)!="#"){this.container="#"+this.container}if(window.experiment==undefined){window.experiment={}}window.experiment[this.container]={};var h=$(this.container);h.attr("style","width: 100%;");h.empty();var l=$("<div>").attr("class","bb_exp_container");var i="bb_right_exp";var d="bb_left_exp";if(this.style.toLowerCase()=="vertical"){i="bb_right_exp_vert";d="bb_left_exp_vert"}var b=$("<div>").attr("class",d);b.append($("<div>").attr("id","bb_widg_container_form").attr("class","bb_widg_container_form"));b.append($("<div>").attr("id","bb_widg_res_out").attr("class","bb_widg_res_out"));this.right=$("<div>").attr("id","bb_right_exp").attr("class",i);l.append(b);l.append(this.right);h.append(l);var f=this;var k=ocpu.rpc("getProcessInputDescription",{wps_uri:f.wps_uri,username:f.wps_username,token:f.wps_token,process_id:f.experiment_identifier,fail:function(c){$("#bb_widg_res_out").html("Error retrieving data from OpenCpu")}},function(D){function C(F,G){return function(){G.changeInput(this,F)}}var q="bb_input_parameters_div";if(f.style.toLowerCase()=="vertical"){q="bb_input_parameters_div_vert"}for(var z=0;z<D.length;z++){var A=$("<div>").attr("class",q);window.experiment[f.container][D[z].Identifier]=D[z].DefaultValue;var o=D[z].Identifier;var x=D[z].Description;var t=$("<div>").attr("class","bb_wid_attr_label").append($("<label>").html(o));var p;if(D[z].AllowedValues.length>1){p=$("<select>").attr("name",D[z].Identifier).attr("id",o).attr("class","form-control").attr("style","margin-bottom: 10px; margin-left: 5px;").change(C(o,f));for(var y=0;y<D[z].AllowedValues.length;y++){p.append($("<option>").attr("value",D[z].AllowedValues[y]).text(D[z].AllowedValues[y]))}}else{p=$("<input>").attr("type","text").attr("name",o).attr("id",o).attr("class","form-control").attr("style","margin-bottom: 10px; margin-left: 5px;").change(C(o,f)).val(D[z].DefaultValue)}var r=$("<div>").attr("class","tooltip2").html("?&nbsp;&nbsp;&nbsp;&nbsp;").append($("<div>").attr("class","tooltiptext2").html(x));var B=$("<div>").attr("class","bb_input_top_side");var E=$("<div>").attr("class","bb_input_bottom_side");B.append(t);B.append($("<div>").attr("class","bb_wid_attr_input").append(p));E.append($("<div>").attr("class","bb_input_desc").html(x));A.append(B);A.append(E);$(f.container).find("#bb_widg_container_form").append(A)}var s=150;var n="...";var v="Show more >";var u="Show less";$(".bb_input_desc").each(function(){var H=$(this).html();if(H.length>s){var I=H.substr(0,s);var G=H.substr(s,H.length-s);var F=I+'<span class="bb_moreellipses">'+n+'&nbsp;</span><span class="bb_morecontent"><span>'+G+'</span>&nbsp;&nbsp;<a href="" class="bb_morelink">'+v+"</a></span>";$(this).html(F)}});$(".bb_morelink").click(function(){if($(this).hasClass("bb_less")){$(this).removeClass("bb_less");$(this).html(v)}else{$(this).addClass("bb_less");$(this).html(u)}$(this).parent().prev().toggle();$(this).prev().toggle();return false});var w=$("<button>").html("Run Experiment").attr("class","btn btn-primary bb_run_experiment_button");w.bind("click",function(){f.runExperiment()});var c=$("<div>").attr("class",q).append(w);$(f.container).find("#bb_widg_container_form").append(c)})}};this.changeInput=function(c,d){for(var b in window.experiment[this.container]){if(b==d){if(c.value.trim()==""){window.experiment[this.container][d]=undefined}else{window.experiment[this.container][d]=c.value}}}};this.getFileType=function(d,b){if(b==undefined){b=false}var e=undefined;var c="uint8array";if(d.name.endsWith(".jpg")||d.name.endsWith(".JPG")||d.name.endsWith(".jpeg")||d.name.endsWith(".JPEG")){e="image/jpg"}else{if(d.name.endsWith(".html")||d.name.endsWith(".HTML")||d.name.endsWith(".htm")||d.name.endsWith(".HTM")){e="text/html"}else{if(d.name.endsWith(".png")||d.name.endsWith(".PNG")){e="image/png"}else{if(d.name.endsWith(".pdf")||d.name.endsWith(".PDF")){e="application/pdf"}else{if(d.name.endsWith(".txt")||d.name.endsWith(".TXT")){e="text/plain";c="string"}else{if(d.name.endsWith(".csv")||d.name.endsWith(".CSV")){e="text/csv";c="string"}}}}}}if(b){return e}else{return c}};this.filterFileList=function(d){for(var g=0;g<this.include.length;g++){var f=this.include[g].toLowerCase();var c=[];for(var b=0;b<d.length;b++){var e=d[b].name.split("/")[d[b].name.split("/").length-1].toLowerCase();if(f.trim()!=e.trim()){c.push(b)}}for(b=c.length-1;b>=0;b--){d.splice(c[b],1)}}if(this.include.length==0){for(var g=0;g<this.exclude.length;g++){var h=this.exclude[g].toLowerCase();for(var b=0;b<d.length;b++){var e=d[b].name.split("/")[d[b].name.split("/").length-1].toLowerCase();if(h.trim()==e.trim()){d.splice(b,1);break}}}}return d};this.runExperiment=function(){var e=$(this.container).find("#bb_widg_res_out");e.empty();e.append($("<img>").attr("src","http://vps282167.ovh.net/BlueBridgeWPSClient/img/wait_progress.gif"));var i=$(this.container);var h=this;var d=[];var g=[];for(var b in window.experiment[this.container]){if(window.experiment[this.container][b]!=undefined){g.push(b);d.push(window.experiment[this.container][b])}}console.debug("sending for: "+this.container);console.debug(g);console.debug(d);var f=ocpu.rpc("getOutput",{wps_uri:this.wps_uri,username:this.wps_username,token:this.wps_token,process_id:this.experiment_identifier,keys:g,values:d,fail:function(j,c){e.empty();if(c!=undefined){e.html(c)}else{e.html("Error running experiment from OpenCpu")}}},function(o){e.empty();var l=[];for(var m=0;m<o.length;m++){l.push($("<div>").attr("class","experimentOutHeader").html());for(var k=0;k<o[m].length;k++){if(h.ValidURL(o[m][k])){if(h.expands){var n=new JSZip();JSZipUtils.getBinaryContent(o[m][k],function(q,p){if(q){throw q}var j=window.URL||window.webkitURL;JSZip.loadAsync(p).then(function(u){var r=[];for(var v in u.files){r.push(u.file(v))}var s=[];var t=r.map(function(w){return new Promise(function(y,x){var z=w;w.async(h.getFileType(z)).then(function(A){var B={data:A,name:z.name,uuid:generateUUID()};B.mime=h.getFileType(z,true);if(z.name.endsWith(".pdf")||z.name.endsWith(".PDF")){B.containerUuid=generateUUID()}s.push(B);y()})})});Promise.all(t).then(function(){var H=$("<ul>").attr("class","nav nav-tabs");var L=$("<div>").attr("class","tab-content").attr("style","height: 100vh; width: 100%;");var z=[];var w=h.filterFileList(s);for(var K=0;K<w.length;K++){var N=w[K];var G=$("<li>");var R=$("<a>").attr("data-toggle","tab").attr("role","tab").attr("href","#"+N.uuid).html(N.name.split("/")[N.name.split("/").length-1]);H.append(G.append(R));var C=$("<div>").attr("id",N.uuid).attr("class","tab-pane fade bb-wid-tab-pane-extra");if(N.mime=="image/jpg"||N.mime=="image/png"){var x=new Blob([N.data],{type:N.mime});var P=j.createObjectURL(x);var I=$("<img>").attr("src",P);C.append(I)}else{if(N.mime=="application/pdf"){var D=$("<div>").attr("id",N.containerUuid).attr("style","height: 100vh; width: 100%;");C.append(D)}else{if(N.mime=="text/html"){var x=new Blob([N.data],{type:N.mime});var Q=j.createObjectURL(x);var J=$("<iframe>").attr("src",Q).attr("style","height: 100vh; width: 100%;");C.append(J)}else{if(N.mime=="text/plain"){C.html(N.data)}else{if(N.mime=="text/csv"){var A=Papa.parse(N.data);var O=$("<table>").attr("class","bb_csv_tbl");for(var F=0;F<A.data.length;F++){var y=$("<tr>");for(var M=0;M<A.data[F].length;M++){var E="bb_wid_td_row";if(F==0){E="bb_wid_td_row_header"}var B=$("<td>").attr("class",E).html(A.data[F][M]);y.append(B)}O.append(y)}C.append(O)}}}}}L.append(C)}$(h.container).find("#bb_right_exp").append(H).append(L);setTimeout(function(){for(var V=0;V<s.length;V++){var X=s[V];if(X.mime=="application/pdf"){var S=X;var U=new Blob([X.data],{type:"application/pdf"});var W=j.createObjectURL(U);var T=$("<a>").attr("href",W).attr("download",S.name).attr("style","margin-left: 20px; line-height: 4;").html("Download PDF File");$("#"+S.containerUuid).append(T);if(PDFObject.supportsPDFs){PDFObject.embed(W,"#"+S.containerUuid)}}}},1000)})})})}var c=$("<a>").attr("href",o[m][k]).attr("target","_blank").html("Download Computed Results");l.push($("<div>").append(c))}}}for(var m=0;m<l.length;m++){e.append(l[m])}})};this.ValidURL=function(c){if(c.startsWith("http")){var b=/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/;return b.test(c)}return false}};